{% extends 'layout/body_main.html' %}
{% block title %}Danh sách chờ TTS{% endblock %}
{% block page %}
    <section class="bg-white rounded-xl shadow p-4">
        <form id="formAddTTS" class="flex flex-col gap-3 mb-4">
            <div class="flex flex-wrap items-center gap-2">
            <select id="ttsKey" class="min-w-[12rem] rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" required>
                <option value="" selected disabled>Chọn key</option>
            </select>
            <input id="ttsChars" type="number" min="0" class="w-32 rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Số ký tự" required />
            <select id="ttsStatus" class="rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
                <option value="pending">đang chờ</option>
                <option value="done">hoàn thành</option>
                <option value="error">lỗi</option>
            </select>
            </div>
            <textarea id="ttsContent" rows="4" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nội dung TTS (1 - 100000 ký tự)"></textarea>
            <div class="flex flex-wrap items-center gap-2">
                <input id="ttsUrl" type="url" class="flex-1 rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="URL (tùy chọn)" />
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-md">Thêm</button>
            </div>
        </form>
        
        <!-- Delete All Button -->
        <div class="flex justify-between items-center mb-4">
            <div class="text-sm text-gray-600">
                <span id="totalCount">0</span> mục TTS
            </div>
            <button id="deleteAllBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                Xóa tất cả TTS
            </button>
        </div>
        <div class="overflow-x-auto w-full">
            <table class="w-full min-w-full text-sm">
                <thead class="bg-slate-50 text-slate-700">
                    <tr>
                        <th class="text-left p-2">ID</th>
                        <th class="text-left p-2">Key</th>
                        <th class="text-left p-2">Ký tự</th>
                        <th class="text-left p-2">Nội dung</th>
                        <th class="text-left p-2">Trạng thái</th>
                        <th class="text-left p-2">URL</th>
                        <th class="text-left p-2">Connection ID</th>
                        <th class="text-left p-2">Updated</th>
                        <th class="text-left p-2">Created</th>
                        <th class="text-left p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="ttsBody">
                    <tr id="emptyTTS" class="hidden">
                        <td colspan="10" class="p-6 text-center text-slate-500">Chưa có mục nào trong hàng đợi.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div id="paginationControls" class="flex justify-between items-center mt-4 px-2">
            <div class="text-sm text-gray-600">
                Trang <span id="currentPage">1</span> / <span id="totalPages">1</span>
            </div>
            <div class="flex gap-2">
                <button id="prevPage" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    Trước
                </button>
                <button id="nextPage" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    Sau
                </button>
            </div>
        </div>
    </section>
{% endblock %}

{% block scripts %}
<script>
    // Guard: require admin key
    const ADMIN_KEY = localStorage.getItem('admin_key');
    if (ADMIN_KEY !== 'anhdagia716') { window.location.replace('/login'); }

    document.getElementById('btnLogout').addEventListener('click', () => {
        localStorage.removeItem('admin_key');
        window.location.replace('/login');
    });

    const ttsBody = document.getElementById('ttsBody');
    const ttsKeySelect = document.getElementById('ttsKey');
    let KEY_OPTIONS = [];
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;

    function statusBadge(status) {
        const map = {
            pending: 'bg-blue-100 text-blue-700',
            done: 'bg-emerald-100 text-emerald-700',
            error: 'bg-rose-100 text-rose-700',
        };
        const cls = map[status] || 'bg-gray-100 text-gray-700';
        const label = status === 'pending' ? 'đang chờ' : (status === 'done' ? 'hoàn thành' : (status === 'error' ? 'lỗi' : status));
        return `<span class="px-2 py-1 rounded text-xs font-medium ${cls}">${label}</span>`;
    }

    async function loadKeysOptions() {
        const res = await fetch('/api/keys');
        KEY_OPTIONS = await res.json();
        ttsKeySelect.innerHTML = '<option value="" disabled selected>Chọn key</option>' +
            KEY_OPTIONS.map(k => `<option value="${k.key}">${k.key}</option>`).join('');
    }

    async function loadTTS(page = 1) {
        const res = await fetch(`/api/tts?page=${page}&per_page=20`);
        const data = await res.json();
        
        // Update pagination info
        currentPage = data.pagination.page;
        totalPages = data.pagination.pages;
        totalItems = data.pagination.total;
        
        // Update UI elements
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('totalCount').textContent = totalItems;
        
        // Update pagination buttons
        document.getElementById('prevPage').disabled = !data.pagination.has_prev;
        document.getElementById('nextPage').disabled = !data.pagination.has_next;
        
        ttsBody.innerHTML = '';
        if (!data.items.length) {
            document.getElementById('emptyTTS').classList.remove('hidden');
            return;
        }
        
        for (const t of data.items) {
            const tr = document.createElement('tr');
            const options = KEY_OPTIONS.map(k => `<option value="${k.key}" ${t.key===k.key?'selected':''}>${k.key}</option>`).join('');
            tr.innerHTML = `
                <td class=\"p-2\">${t.id}</td>
                <td class=\"p-2\">
                    <select data-field=\"key\" data-id=\"${t.id}\" class=\"min-w-[12rem] rounded-md border-gray-300\">${options}</select>
                </td>
                <td class=\"p-2\"><input data-field=\"text_char_count\" data-id=\"${t.id}\" type=\"number\" value=\"${t.text_char_count}\" class=\"w-24 rounded-md border-gray-300\" /></td>
                <td class=\"p-2 max-w-[24rem] truncate\" title=\"${(t.content || '').replace(/\"/g,'\\\"')}\">${(t.content || '').slice(0,50)}${(t.content||'').length>50?'...':''}</td>
                <td class=\"p-2\">${statusBadge(t.status)}</td>
                <td class=\"p-2\">
                    <input data-field=\"url\" data-id=\"${t.id}\" type=\"url\" value=\"${t.url || ''}\" class=\"w-full rounded-md border-gray-300 text-xs\" placeholder=\"URL\" />
                </td>
                <td class=\"p-2 text-xs text-gray-500 font-mono\">${t.connection_id || '-'}</td>
                <td class=\"p-2\">${t.updatedAt || ''}</td>
                <td class=\"p-2\">${t.createdAt || ''}</td>
                <td class=\"p-2 flex gap-2\">
                    <button data-action=\"delete\" data-id=\"${t.id}\" class=\"px-2 py-1 bg-rose-600 text-white rounded\">Xoá</button>
                </td>`;
            ttsBody.appendChild(tr);
        }
    }

    document.getElementById('formAddTTS').addEventListener('submit', async (e) => {
        e.preventDefault();
        const keyValue = ttsKeySelect.value;
        const chars = parseInt(document.getElementById('ttsChars').value, 10);
        const status = document.getElementById('ttsStatus').value;
        const content = document.getElementById('ttsContent').value;
        const url = document.getElementById('ttsUrl').value;
        await fetch('/api/tts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: keyValue, text_char_count: chars, status, content, url }) });
        e.target.reset();
        await loadKeysOptions();
        loadTTS(1); // Reset to first page after adding new item
    });

    ttsBody.addEventListener('change', async (e) => {
        const input = e.target;
        const id = input.getAttribute('data-id');
        if (!id) return;
        const payload = {};
        for (const field of ['key','text_char_count','url']) {
            const el = ttsBody.querySelector(`[data-field=\"${field}\"][data-id=\"${id}\"]`);
            if (el) payload[field] = el.type === 'number' ? Number(el.value) : el.value;
        }
        await fetch(`/api/tts/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        loadTTS(currentPage);
    });

    ttsBody.addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.getAttribute('data-id');
        const action = target.getAttribute('data-action');
        if (!id || !action) return;
        if (action === 'delete') {
            await fetch(`/api/tts/${id}`, { method: 'DELETE' });
        }
        loadTTS(currentPage);
    });

    // Pagination event listeners
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            loadTTS(currentPage - 1);
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < totalPages) {
            loadTTS(currentPage + 1);
        }
    });

    // Delete all TTS event listener
    document.getElementById('deleteAllBtn').addEventListener('click', async () => {
        if (confirm('Bạn có chắc chắn muốn xóa tất cả TTS? Hành động này không thể hoàn tác.')) {
            try {
                const response = await fetch('/api/tts/delete-all', { method: 'DELETE' });
                const result = await response.json();
                if (result.ok) {
                    alert('Đã xóa tất cả TTS thành công!');
                    loadTTS(1); // Reset to first page
                } else {
                    alert('Có lỗi xảy ra: ' + (result.error || 'Không xác định'));
                }
            } catch (error) {
                alert('Có lỗi xảy ra: ' + error.message);
            }
        }
    });

    (async () => { await loadKeysOptions(); await loadTTS(1); })();
</script>
{% endblock %}

